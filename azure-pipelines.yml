name: Azure Static Web Apps CI/CD

trigger:
  branches:
    include:
      - master
pr:
  branches:
    include:
      - master

jobs:
- job: build_and_deploy_job
  displayName: Build and Deploy DocFX to SWA
  pool:
    vmImage: ubuntu-latest
  variables:
  - group: Azure-Static-Web-Apps-nice-grass-0fed7761e-variable-group

  steps:
  - checkout: self
    submodules: false

  # Build DocFX
  - task: UseDotNet@2
    displayName: Use .NET 8 SDK
    inputs:
      packageType: sdk
      version: 8.x

  - script: |
      set -euo pipefail
      dotnet tool update -g docfx
      export PATH="$HOME/.dotnet/tools:$PATH"

      # Find docfx.json or docfx.yml (adjust if you know the exact path)
      DOCFX_CFG="$(find "$(pwd)" -maxdepth 4 -type f \( -name docfx.json -o -name docfx.yml \) -not -path '*/.*/*' | head -n 1 || true)"
      if [ -z "${DOCFX_CFG}" ]; then
        echo "ERROR: Could not find docfx.json or docfx.yml in repo."
        exit 1
      fi
      DOCFX_DIR="$(dirname "${DOCFX_CFG}")"
      mkdir -p "_site"
      (cd "${DOCFX_DIR}" && docfx metadata "${DOCFX_CFG}" && docfx build "${DOCFX_CFG}" --output "$(pwd)/_site")
    displayName: Build DocFX site

  # Deploy to SWA (skip build; deploy the generated _site)
  - task: AzureStaticWebApp@0
    displayName: Deploy to Azure Static Web Apps
    inputs:
      azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_NICE_GRASS_0FED7761E)
      app_location: "_site"           # point directly to built output
      output_location: ""             # empty when skipping build
      skip_app_build: true            # critical: do not run Oryx
